<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DotKeeper</title>
    <style>
        :root {
            --bg-color: #1e1e2e;
            --text-color: #cdd6f4;
            --surface0: #313244;
            --surface1: #45475a;
            --primary: #89b4fa;
            --success: #a6e3a1;
            --warning: #f9e2af;
            --error: #f38ba8;
            --subtext: #a6adc8;
        }
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #app {
            display: flex;
            width: 100%;
        }
        .sidebar {
            width: 300px;
            background-color: var(--surface0);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--surface1);
        }
        .header {
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid var(--surface1);
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lang-select {
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--surface1);
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 0.8rem;
        }
        .package-list {
            flex: 1;
            overflow-y: auto;
        }
        .package-item {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--surface1);
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .package-item:hover, .package-item.active {
            background-color: var(--surface1);
        }
        .package-item.active {
            border-left: 4px solid var(--primary);
        }
        .status-badge {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--surface0);
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            position: relative;
        }
        .content-header {
            padding: 20px;
            background-color: var(--surface0);
            border-bottom: 1px solid var(--surface1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        .btn-deploy { background-color: var(--primary); color: var(--bg-color); }
        .btn-restore { background-color: var(--warning); color: var(--bg-color); }
        .btn-refresh { background-color: var(--surface1); color: var(--text-color); }
        .btn-diff { background-color: var(--surface1); color: var(--text-color); font-size: 0.8rem; padding: 4px 8px; }

        select {
            padding: 8px;
            border-radius: 4px;
            background-color: var(--surface1);
            color: var(--text-color);
            border: none;
        }
        
        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .file-item {
            background-color: var(--surface0);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-path {
            font-family: monospace;
            color: var(--primary);
        }
        .file-state {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .state-linked { color: var(--success); }
        .state-conflict { color: var(--error); }
        .state-missing { color: var(--subtext); }
        .state-orphan { color: var(--warning); }
        
        .logs-panel {
            height: 200px;
            background-color: #11111b;
            border-top: 1px solid var(--surface1);
            padding: 10px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-line { margin: 2px 0; }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-right: 15px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--bg-color);
            width: 80%;
            max-width: 900px;
            height: 80%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--surface1);
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--surface1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        .modal-body {
            flex: 1;
            padding: 20px;
            overflow: auto;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #11111b;
            color: var(--text-color);
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
        }
        .diff-add { color: var(--success); }
        .diff-remove { color: var(--error); }
        .diff-header { color: var(--primary); }
    </style>
</head>
<body>
    <div id="app">
        <div class="sidebar">
            <div class="header">
                <span>{{ t('title') }}</span>
                <select v-model="lang" class="lang-select">
                    <option value="en">EN</option>
                    <option value="zh">中文</option>
                </select>
            </div>
            <div class="package-list">
                <div 
                    v-for="pkg in packages" 
                    :key="pkg.name"
                    class="package-item"
                    :class="{ active: selectedPackage && selectedPackage.name === pkg.name }"
                    @click="selectPackage(pkg)"
                >
                    <span>{{ pkg.name }}</span>
                    <span class="status-badge">{{ pkg.status }}</span>
                </div>
            </div>
            <div style="padding: 10px;">
                <button class="btn-refresh" style="width: 100%" @click="fetchPackages">{{ t('refresh') }}</button>
                <button class="btn-refresh" style="width: 100%; margin-top: 10px" @click="backupConfig">{{ t('backup_config') }}</button>
            </div>
        </div>
        
        <div class="main-content" v-if="selectedPackage">
            <div class="content-header">
                <div>
                    <h2 style="margin: 0">{{ selectedPackage.name }}</h2>
                    <small style="color: var(--subtext)">{{ selectedPackage.path }}</small>
                </div>
                <div class="actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="dryrun" v-model="dryRun">
                        <label for="dryrun">{{ t('dry_run') }}</label>
                    </div>
                    
                    <div style="display: flex; gap: 5px;">
                         <select v-model="restoreStrategy" :title="t('strategy_title')">
                            <option value="backup">{{ t('backup') }}</option>
                            <option value="overwrite">{{ t('overwrite') }}</option>
                        </select>
                        <button class="btn-deploy" @click="runAction('deploy')">{{ t('deploy') }}</button>
                    </div>
                    
                    <button class="btn-restore" @click="runAction('restore')">{{ t('undo') }}</button>
                </div>
            </div>
            
            <div class="file-list">
                <div v-for="file in selectedPackage.files" :key="file.source" class="file-item">
                    <div class="file-header">
                        <div class="file-path">{{ file.rel_path }}</div>
                        <button class="btn-diff" @click="showDiff(file)">{{ t('diff') }}</button>
                    </div>
                    <div class="file-state">
                        {{ t('status') }}: <span :class="'state-' + file.state">{{ formatState(file.state) }}</span>
                        <span style="color: var(--subtext)">{{ t('target') }}: {{ file.target }}</span>
                    </div>
                </div>
            </div>
            
            <div class="logs-panel">
                <div style="color: var(--subtext); margin-bottom: 5px;">{{ t('logs') }}:</div>
                <div v-for="(log, i) in logs" :key="i" class="log-line">{{ formatLog(log) }}</div>
            </div>

            <!-- Diff Modal -->
            <div v-if="isDiffOpen" class="modal-overlay" @click.self="closeDiff">
                <div class="modal-content">
                    <div class="modal-header">
                        <span>{{ t('file_diff') }}: {{ diffTargetName }}</span>
                        <button class="close-btn" @click="closeDiff">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div v-if="diffContent.length === 0">{{ t('no_diff') }}</div>
                        <div v-for="(line, i) in diffContent" :key="i" :class="getDiffClass(line)">{{ line }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content" v-else style="justify-content: center; align-items: center; color: var(--subtext)">
            {{ t('select_pkg') }}
        </div>
    </div>

    <!-- Minimal Vue 3 via CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, onMounted, computed } = Vue

        const messages = {
            en: {
                title: "DotKeeper",
                refresh: "Refresh Scan",
                dry_run: "Dry Run",
                backup: "Backup & Overwrite",
                overwrite: "Force Overwrite",
                strategy_title: "Conflict Strategy",
                deploy: "Deploy",
                undo: "Undo",
                diff: "Diff",
                status: "Status",
                target: "Target",
                logs: "Activity Logs",
                file_diff: "File Diff",
                no_diff: "No difference or file unreadable.",
                select_pkg: "Select a package to view details",
                loading: "Loading...",
                strategy: "Strategy",
                executing: "Executing {action} on {pkg} (Dry Run: {dry})...",
                error_fetch: "Error fetching packages",
                request_failed: "Request failed",
                error: "Error",
                no_ops: "No operations executed.",
                state_linked: "Linked",
                state_conflict: "Conflict",
                state_missing: "Missing",
                state_orphan: "Orphan",
                backup_config: "Backup ~/.config"
            },
            zh: {
                title: "DotKeeper",
                refresh: "刷新扫描",
                dry_run: "空跑",
                backup: "备份并覆盖",
                overwrite: "强制覆盖",
                strategy_title: "冲突策略",
                deploy: "部署",
                undo: "撤销",
                diff: "差异",
                status: "状态",
                target: "目标",
                logs: "活动日志",
                file_diff: "文件差异",
                no_diff: "无差异或无法读取文件。",
                select_pkg: "请选择一个包查看详情",
                loading: "加载中...",
                strategy: "策略",
                executing: "正在对 {pkg} 执行 {action} (空跑: {dry})...",
                error_fetch: "获取包列表出错",
                request_failed: "请求失败",
                error: "错误",
                no_ops: "未执行任何操作。",
                state_linked: "已链接",
                state_conflict: "冲突",
                state_missing: "缺失",
                state_orphan: "孤立",
                backup_config: "一键备份 ~/.config"
            }
        }

        createApp({
            setup() {
                // Language Detection
                const initialLang = navigator.language.startsWith('zh') ? 'zh' : 'en'
                const lang = ref(initialLang)
                
                const t = (key) => {
                    return messages[lang.value][key] || key
                }

                // Helper to format bilingual logs from backend (format: "English / Chinese")
                const formatLog = (log) => {
                    if (typeof log !== 'string') return log
                    const parts = log.split(' / ')
                    if (parts.length === 2) {
                        return lang.value === 'zh' ? parts[1] : parts[0]
                    }
                    // Try to guess if it's the specific header line
                    if (log.startsWith('[BACKUP]')) return log // Already likely bilingual or code
                    return log
                }

                const packages = ref([])
                const selectedPackage = ref(null)
                const logs = ref([])
                const dryRun = ref(true)
                const restoreStrategy = ref('backup')
                
                // Diff State
                const isDiffOpen = ref(false)
                const diffContent = ref([])
                const diffTargetName = ref('')

                const formatState = (state) => {
                    const key = 'state_' + state
                    return t(key)
                }

                const fetchPackages = async () => {
                    try {
                        const res = await fetch('/api/scan')
                        packages.value = await res.json()
                        if (selectedPackage.value) {
                            const found = packages.value.find(p => p.name === selectedPackage.value.name)
                            if (found) selectedPackage.value = found
                        }
                    } catch (e) {
                        logs.value.push(`${t('error_fetch')}: ${e}`)
                    }
                }

                const selectPackage = (pkg) => {
                    selectedPackage.value = pkg
                    logs.value = [] // Clear logs on switch
                }

                const runAction = async (action) => {
                    if (!selectedPackage.value) return
                    
                    const actionName = action === 'deploy' ? t('deploy') : t('undo')
                    // Manually formatting the executing string
                    let logMsg = messages[lang.value].executing
                        .replace('{action}', actionName)
                        .replace('{pkg}', selectedPackage.value.name)
                        .replace('{dry}', dryRun.value)
                    
                    logs.value = [logMsg]
                    
                    const payload = {
                        package: selectedPackage.value.name,
                        dry_run: dryRun.value,
                        strategy: restoreStrategy.value
                    }
                    
                    if (action === 'deploy') {
                        logs.value.push(`${t('strategy')}: ${restoreStrategy.value}`)
                    }
                    
                    try {
                        const res = await fetch(`/api/${action}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        })
                        const data = await res.json()
                        if (data.status === 'success') {
                            // Backend logs are bilingual "En / Zh". formatLog will handle them.
                            logs.value = [...logs.value, ...data.logs]
                            if (data.logs.length === 0) logs.value.push(t('no_ops'))
                            if (!dryRun.value) fetchPackages()
                        } else {
                            logs.value.push(`${t('error')}: ${data.message}`)
                        }
                    } catch (e) {
                        logs.value.push(`${t('request_failed')}: ${e}`)
                    }
                }

                const backupConfig = async () => {
                    let logMsg = messages[lang.value].executing
                        .replace('{action}', t('backup_config'))
                        .replace('{pkg}', '~/.config')
                        .replace('{dry}', dryRun.value)

                    logs.value = [logMsg]

                    const payload = {
                        dry_run: dryRun.value
                    }

                    try {
                        const res = await fetch(`/api/backup-config`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        })
                        const data = await res.json()
                        if (data.status === 'success') {
                            logs.value = [...logs.value, ...data.logs]
                            if (data.logs.length === 0) logs.value.push(t('no_ops'))
                        } else {
                            logs.value.push(`${t('error')}: ${data.message}`)
                        }
                    } catch (e) {
                        logs.value.push(`${t('request_failed')}: ${e}`)
                    }
                }

                const showDiff = async (file) => {
                    diffTargetName.value = file.rel_path
                    isDiffOpen.value = true
                    diffContent.value = [t('loading')]
                    
                    try {
                        const params = new URLSearchParams({
                            source: file.source,
                            target: file.target
                        })
                        const res = await fetch(`/api/diff?${params}`)
                        const data = await res.json()
                        diffContent.value = data.diff
                    } catch (e) {
                        diffContent.value = [`Error: ${e}`]
                    }
                }

                const closeDiff = () => {
                    isDiffOpen.value = false
                    diffContent.value = []
                }

                const getDiffClass = (line) => {
                    if (line.startsWith('+')) return 'diff-add'
                    if (line.startsWith('-')) return 'diff-remove'
                    if (line.startsWith('@@') || line.startsWith('+++') || line.startsWith('---')) return 'diff-header'
                    return ''
                }

                onMounted(() => {
                    fetchPackages()
                })

                return {
                    packages,
                    selectedPackage,
                    logs,
                    dryRun,
                    restoreStrategy,
                    selectPackage,
                    runAction,
                    backupConfig,
                    fetchPackages,
                    formatState,
                    
                    // Diff
                    isDiffOpen,
                    diffContent,
                    diffTargetName,
                    showDiff,
                    closeDiff,
                    getDiffClass,
                    
                    // i18n
                    lang,
                    t,
                    formatLog
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
